<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Book Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Compat Library -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Tailwind Config for Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .prose p { margin-bottom: 0.75em; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-slate-900 dark:text-gray-100 transition-colors duration-300 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Constants ---

        // Adjusted to -300 shades for the 'dot' to be softer/less neon
        const PASTEL_PALETTE = [
            { id: 'rose', name: 'Rose', bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-600', dot: 'bg-rose-300' },
            { id: 'orange', name: 'Orange', bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-600', dot: 'bg-orange-300' },
            { id: 'amber', name: 'Amber', bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-600', dot: 'bg-amber-300' },
            { id: 'lime', name: 'Lime', bg: 'bg-lime-50', border: 'border-lime-200', text: 'text-lime-600', dot: 'bg-lime-300' },
            { id: 'green', name: 'Green', bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-600', dot: 'bg-green-300' },
            { id: 'teal', name: 'Teal', bg: 'bg-teal-50', border: 'border-teal-200', text: 'text-teal-600', dot: 'bg-teal-300' },
            { id: 'sky', name: 'Sky', bg: 'bg-sky-50', border: 'border-sky-200', text: 'text-sky-600', dot: 'bg-sky-300' },
            { id: 'indigo', name: 'Indigo', bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-600', dot: 'bg-indigo-300' },
            { id: 'violet', name: 'Violet', bg: 'bg-violet-50', border: 'border-violet-200', text: 'text-violet-600', dot: 'bg-violet-300' },
            { id: 'purple', name: 'Purple', bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-600', dot: 'bg-purple-300' },
            { id: 'fuchsia', name: 'Fuchsia', bg: 'bg-fuchsia-50', border: 'border-fuchsia-200', text: 'text-fuchsia-600', dot: 'bg-fuchsia-300' },
            { id: 'gray', name: 'Gray', bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-600', dot: 'bg-gray-300' },
        ];

        const STATUS_OPTIONS = [
            { id: 'want-to-read', label: 'Want to Read', icon: 'bookmark', color: 'bg-gray-500' },
            { id: 'reading', label: 'Reading', icon: 'book-open', color: 'bg-blue-500' },
            { id: 'finished', label: 'Finished', icon: 'check-circle', color: 'bg-green-500' },
        ];

        // --- Helper Functions ---
        
        // Helper to get higher quality image from Google Books
        const getHighResImage = (link) => {
            if (!link) return "";
            // Replace http with https
            let url = link.replace('http:', 'https:');
            // Remove curl edge effect which often adds blur/border
            url = url.replace('&edge=curl', '');
            // Try to request zoom=0 (often highest res) instead of zoom=1
            if (url.includes('&zoom=1')) {
                url = url.replace('&zoom=1', '&zoom=0');
            }
            return url;
        };

        // --- Helper Components ---

        const Icon = ({ name, size = 24, className = "" }) => {
            return <i className={`ph ph-${name} ${className}`} style={{ fontSize: size }}></i>;
        };

        const StarRating = ({ rating, onRate, editable = false }) => {
            return (
                <div className="flex gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <button
                            key={star}
                            type="button"
                            onClick={(e) => {
                                e.stopPropagation();
                                if (editable && onRate) onRate(star);
                            }}
                            className={`${editable ? 'cursor-pointer hover:scale-110 transition-transform' : 'cursor-default'} focus:outline-none p-0.5`}
                        >
                            <i 
                                className={star <= rating ? "ph-fill ph-star text-yellow-400" : "ph ph-star text-gray-300 dark:text-gray-600"}
                                style={{ fontSize: 24 }}
                            ></i>
                        </button>
                    ))}
                </div>
            );
        };

        const StatusBadge = ({ status }) => {
            const config = STATUS_OPTIONS.find(s => s.id === status) || STATUS_OPTIONS[0];
            return (
                <div className={`absolute top-2 left-2 ${config.color} text-white text-xs font-bold px-2 py-1 rounded-full shadow-md flex items-center gap-1`}>
                    <Icon name={config.icon} size={12} /> {config.label}
                </div>
            );
        };

        const BookCard = ({ book, onClick, onDelete }) => {
            return (
                <div 
                    onClick={() => onClick(book)}
                    className="bg-white dark:bg-slate-800 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden cursor-pointer group border border-gray-100 dark:border-slate-700 flex flex-col h-full"
                >
                    <div className="relative h-48 bg-gray-100 dark:bg-slate-700 overflow-hidden">
                        {book.thumbnail ? (
                            <img src={book.thumbnail} alt={book.title} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" />
                        ) : (
                            <div className="w-full h-full flex items-center justify-center text-gray-400 dark:text-gray-500">
                                <Icon name="book" size={48} />
                            </div>
                        )}
                        <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <button 
                                onClick={(e) => { e.stopPropagation(); onDelete(book.id); }}
                                className="bg-red-500 text-white p-2 rounded-full shadow-lg hover:bg-red-600"
                                title="Delete Book"
                            >
                                <Icon name="trash" size={16} />
                            </button>
                        </div>
                        
                        <StatusBadge status={book.status || 'want-to-read'} />
                    </div>
                    <div className="p-4 flex-1 flex flex-col">
                        <h3 className="font-bold text-lg leading-tight mb-1 line-clamp-2" title={book.title}>{book.title}</h3>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mb-2">{book.authors?.join(", ") || "Unknown Author"}</p>
                        
                        <div className="mt-auto pt-3 border-t border-gray-100 dark:border-slate-700 flex items-center justify-between">
                            <StarRating rating={book.rating || 0} />
                            <span className="text-xs bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded text-gray-600 dark:text-gray-300">
                                {book.categories?.[0] || "General"}
                            </span>
                        </div>
                    </div>
                </div>
            );
        };

        const ColorPicker = ({ selectedId, onSelect, size = "md" }) => {
            return (
                <div className="flex flex-wrap gap-2">
                    {PASTEL_PALETTE.map((color) => (
                        <button
                            key={color.id}
                            type="button"
                            onClick={() => onSelect(color.id)}
                            className={`${color.dot} rounded-full transition-all 
                                ${size === 'sm' ? 'w-4 h-4' : 'w-6 h-6'} 
                                ${selectedId === color.id ? 'ring-2 ring-offset-2 ring-blue-500 dark:ring-offset-slate-800 scale-110' : 'hover:scale-110 opacity-70 hover:opacity-100'}`}
                            title={color.name}
                        />
                    ))}
                </div>
            );
        };

        // --- Modals ---

        const AddBookModal = ({ isOpen, onClose, onAdd }) => {
            const [query, setQuery] = useState("");
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);

            const searchBooks = async () => {
                if (!query) return;
                setLoading(true);
                try {
                    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10`);
                    const data = await res.json();
                    setResults(data.items || []);
                } catch (error) {
                    console.error("Failed to fetch books", error);
                }
                setLoading(false);
            };

            const handleAdd = (item) => {
                const info = item.volumeInfo;
                // Prefer largest available image
                const rawThumbnail = info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail;
                
                const newBook = {
                    id: Date.now().toString(), 
                    googleId: item.id,
                    title: info.title,
                    authors: info.authors || [],
                    thumbnail: getHighResImage(rawThumbnail),
                    description: info.description || "",
                    pageCount: info.pageCount || 0,
                    categories: info.categories || [],
                    rating: 0,
                    status: 'want-to-read', // Default status
                    notes: [],
                    dateAdded: new Date().toISOString()
                };
                onAdd(newBook);
                onClose();
                setQuery("");
                setResults([]);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl animate-in fade-in zoom-in duration-200">
                        <div className="p-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
                            <h2 className="text-xl font-bold">Add New Book</h2>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-full">
                                <Icon name="x" />
                            </button>
                        </div>
                        
                        <div className="p-4">
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    placeholder="Search by title, author, or ISBN..."
                                    className="flex-1 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={query}
                                    onChange={(e) => setQuery(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && searchBooks()}
                                />
                                <button 
                                    onClick={searchBooks}
                                    disabled={loading}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50"
                                >
                                    {loading ? 'Searching...' : 'Search'}
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {results.length === 0 && !loading && (
                                <div className="text-center text-gray-400 py-8">
                                    <Icon name="magnifying-glass" size={48} className="mx-auto mb-2 opacity-50" />
                                    <p>Search for a book to add it to your library</p>
                                </div>
                            )}
                            {results.map((item) => (
                                <div key={item.id} className="flex gap-4 p-3 hover:bg-gray-50 dark:hover:bg-slate-700/50 rounded-lg border border-transparent hover:border-gray-200 dark:hover:border-slate-600 transition-colors group">
                                    <div className="w-16 h-24 flex-shrink-0 bg-gray-200 dark:bg-slate-700 rounded overflow-hidden">
                                        {item.volumeInfo.imageLinks?.thumbnail && (
                                            <img src={item.volumeInfo.imageLinks.thumbnail.replace('http:', 'https:')} alt="" className="w-full h-full object-cover" />
                                        )}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <h4 className="font-bold truncate">{item.volumeInfo.title}</h4>
                                        <p className="text-sm text-gray-500 dark:text-gray-400 truncate">
                                            {item.volumeInfo.authors?.join(", ")}
                                        </p>
                                    </div>
                                    <button 
                                        onClick={() => handleAdd(item)}
                                        className="self-center px-4 py-2 bg-gray-100 dark:bg-slate-700 hover:bg-blue-600 hover:text-white dark:hover:bg-blue-600 rounded-lg font-medium text-sm transition-colors opacity-0 group-hover:opacity-100"
                                    >
                                        Add
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white dark:bg-slate-800 rounded-xl max-w-sm w-full p-6 shadow-2xl animate-in fade-in zoom-in duration-200">
                        <h3 className="text-lg font-bold mb-2 text-gray-900 dark:text-white">{title}</h3>
                        <p className="text-gray-500 dark:text-gray-400 mb-6">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button 
                                onClick={onClose}
                                className="px-4 py-2 rounded-lg font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={onConfirm}
                                className="px-4 py-2 rounded-lg font-medium bg-red-600 text-white hover:bg-red-700 transition-colors"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SyncSettingsModal = ({ isOpen, onClose, onSave, currentConfig, onClear, currentCollection, onCollectionChange }) => {
            const [configStr, setConfigStr] = useState("");
            const [localCollection, setLocalCollection] = useState(currentCollection || "books");
            
            useEffect(() => {
                if(isOpen) {
                    setConfigStr(currentConfig ? JSON.stringify(currentConfig, null, 2) : "");
                    setLocalCollection(currentCollection || "books");
                }
            }, [isOpen, currentConfig, currentCollection]);

            if (!isOpen) return null;

            const handleSave = () => {
                try {
                    let text = configStr.trim();
                    if (text.includes('=')) text = text.split('=')[1].trim();
                    if (text.endsWith(';')) text = text.slice(0, -1).trim();
                    
                    const parseLoose = new Function("return " + text);
                    const config = parseLoose();
                    
                    if (!config || !config.apiKey) throw new Error("Missing API Key");

                    const cleanCollection = localCollection.trim().replace(/[^a-zA-Z0-9_-]/g, "_") || "books";
                    onSave(config, cleanCollection);
                } catch (e) {
                    console.error(e);
                    alert("Could not parse the config. Please copy the entire block from Firebase and try again.");
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-lg p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="cloud" className="text-blue-500"/> Cloud Sync Setup
                            </h2>
                            <button onClick={onClose}><Icon name="x" /></button>
                        </div>
                        
                        <div className="mb-6 space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">1. Select or Create List</label>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <button 
                                        onClick={() => setLocalCollection('alices-books')}
                                        className={`flex items-center justify-center gap-2 py-3 px-4 rounded-xl border font-medium transition-all ${localCollection === 'alices-books' ? 'bg-blue-50 border-blue-500 text-blue-700 ring-1 ring-blue-500 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-400' : 'border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50 dark:border-slate-700 dark:text-gray-400 dark:hover:bg-slate-700'}`}
                                    >
                                        <Icon name="user" /> Alice's Books
                                    </button>
                                    <button 
                                        onClick={() => setLocalCollection('daniels-books')}
                                        className={`flex items-center justify-center gap-2 py-3 px-4 rounded-xl border font-medium transition-all ${localCollection === 'daniels-books' ? 'bg-purple-50 border-purple-500 text-purple-700 ring-1 ring-purple-500 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-400' : 'border-gray-200 text-gray-600 hover:border-gray-300 hover:bg-gray-50 dark:border-slate-700 dark:text-gray-400 dark:hover:bg-slate-700'}`}
                                    >
                                        <Icon name="user" /> Daniel's Books
                                    </button>
                                </div>
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs uppercase font-bold tracking-wider">Custom ID</span>
                                    <input 
                                        type="text"
                                        className="w-full bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg py-2 pl-24 pr-4 focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                        value={localCollection}
                                        onChange={(e) => setLocalCollection(e.target.value)}
                                        placeholder="e.g. shared-list"
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">2. Firebase Config</label>
                                <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">
                                    Create a project at <a href="https://console.firebase.google.com" target="_blank" className="text-blue-500 underline">console.firebase.google.com</a>, create a Firestore database (Test mode), and copy the <code>firebaseConfig</code>.
                                </p>
                                <textarea
                                    className="w-full h-32 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg p-3 text-xs font-mono focus:ring-2 focus:ring-blue-500 outline-none"
                                    placeholder='Paste your firebaseConfig code here...'
                                    value={configStr}
                                    onChange={(e) => setConfigStr(e.target.value)}
                                ></textarea>
                            </div>
                        </div>

                        <div className="flex justify-between">
                            {currentConfig ? (
                                <button onClick={onClear} className="text-red-500 text-sm hover:underline">Disconnect & Clear</button>
                            ) : <div></div>}
                            
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-gray-500">Cancel</button>
                                <button onClick={handleSave} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">Connect</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const BookDetail = ({ book, onBack, onUpdate, onDelete }) => {
            const [noteText, setNoteText] = useState("");
            const [notePage, setNotePage] = useState("");
            const [noteLine, setNoteLine] = useState("");
            const [selectedColor, setSelectedColor] = useState("blue"); // Default color
            const [filterColor, setFilterColor] = useState("all");
            
            // State for changing color of an existing note
            const [colorPickerNoteId, setColorPickerNoteId] = useState(null);
            
            // State for editing text of an existing note
            const [textEditingId, setTextEditingId] = useState(null);
            const [editText, setEditText] = useState("");
            const [editPage, setEditPage] = useState("");
            const [editLine, setEditLine] = useState("");

            const handleAddNote = (e) => {
                e.preventDefault();
                if (!noteText.trim()) return;

                const newNote = {
                    id: Date.now(),
                    text: noteText,
                    page: notePage,
                    line: noteLine,
                    date: new Date().toISOString(),
                    colorId: selectedColor
                };
                
                const updatedBook = { ...book, notes: [newNote, ...book.notes] };
                onUpdate(updatedBook);
                
                setNoteText("");
                setNotePage("");
                setNoteLine("");
            };

            const handleDeleteNote = (noteId) => {
                const updatedBook = { ...book, notes: book.notes.filter(n => n.id !== noteId) };
                onUpdate(updatedBook);
            };

            const handleEditNoteColor = (noteId, newColorId) => {
                const updatedNotes = book.notes.map(note => 
                    note.id === noteId ? { ...note, colorId: newColorId } : note
                );
                onUpdate({ ...book, notes: updatedNotes });
                setColorPickerNoteId(null);
            };

            // Start editing text
            const handleStartEdit = (note) => {
                setTextEditingId(note.id);
                setEditText(note.text);
                setEditPage(note.page || "");
                setEditLine(note.line || "");
                setColorPickerNoteId(null); // Close color picker if open
            };

            // Save edited text
            const handleSaveEdit = (noteId) => {
                const updatedNotes = book.notes.map(note => 
                    note.id === noteId ? { ...note, text: editText, page: editPage, line: editLine } : note
                );
                onUpdate({ ...book, notes: updatedNotes });
                setTextEditingId(null);
                setEditText("");
                setEditPage("");
                setEditLine("");
            };

            const handleRatingChange = (newRating) => {
                onUpdate({ ...book, rating: newRating });
            };
            
            const handleStatusChange = (newStatus) => {
                onUpdate({ ...book, status: newStatus });
            };

            const filteredNotes = book.notes.filter(note => {
                if (filterColor === 'all') return true;
                const noteColorId = note.colorId || (note.color ? note.color.name.toLowerCase() : 'gray');
                return noteColorId === filterColor;
            });

            return (
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-300">
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={onBack} className="flex items-center gap-2 text-gray-500 hover:text-blue-600 transition-colors">
                            <Icon name="arrow-left" /> Back to Library
                        </button>
                        <button 
                            onClick={() => onDelete(book.id)}
                            className="flex items-center gap-2 bg-red-100 hover:bg-red-200 text-red-600 px-4 py-2 rounded-lg font-medium transition-colors"
                        >
                            <Icon name="trash" /> Delete Book
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div className="space-y-6">
                            <div className="aspect-[2/3] w-full max-w-sm mx-auto bg-gray-200 dark:bg-slate-700 rounded-xl overflow-hidden shadow-xl">
                                {book.thumbnail ? (
                                    <img src={book.thumbnail} alt={book.title} className="w-full h-full object-cover" />
                                ) : (
                                    <div className="flex items-center justify-center h-full">
                                        <Icon name="book" size={64} className="text-gray-400" />
                                    </div>
                                )}
                            </div>
                            
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
                                <h3 className="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Reading Status</h3>
                                <div className="space-y-2">
                                    {STATUS_OPTIONS.map(status => (
                                        <button
                                            key={status.id}
                                            onClick={() => handleStatusChange(status.id)}
                                            className={`w-full flex items-center gap-3 p-3 rounded-lg border transition-all
                                                ${(book.status || 'want-to-read') === status.id 
                                                    ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500 dark:bg-blue-900/20 dark:border-blue-500' 
                                                    : 'border-gray-200 hover:bg-gray-50 dark:border-slate-700 dark:hover:bg-slate-700'}`}
                                        >
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white ${status.color}`}>
                                                <Icon name={status.icon} size={16} />
                                            </div>
                                            <span className="font-medium text-sm">{status.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
                                <h3 className="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Rating</h3>
                                <div className="flex justify-center mb-2">
                                    <StarRating rating={book.rating} onRate={handleRatingChange} editable={true} />
                                </div>
                                <p className="text-center text-sm text-gray-500 dark:text-gray-400">
                                    {book.rating > 0 ? `You rated this ${book.rating}/5` : "No rating yet"}
                                </p>
                            </div>

                             <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
                                <h3 className="text-sm font-bold uppercase tracking-wider text-gray-400 mb-2">Details</h3>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-gray-500">Pages</span>
                                        <span>{book.pageCount}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-500">Genre</span>
                                        <span>{book.categories?.[0] || "-"}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-500">Added</span>
                                        <span>{new Date(book.dateAdded).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="md:col-span-2 space-y-8">
                            <div>
                                <h1 className="text-4xl font-bold mb-2 text-gray-900 dark:text-white">{book.title}</h1>
                                <p className="text-xl text-gray-500 dark:text-gray-400 mb-6">by {book.authors?.join(", ")}</p>
                                <div className="prose dark:prose-invert max-w-none text-gray-600 dark:text-gray-300" 
                                     dangerouslySetInnerHTML={{ __html: book.description }}>
                                </div>
                            </div>

                            <div className="border-t border-gray-200 dark:border-slate-700 pt-8">
                                <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                                    <div className="flex items-center gap-2">
                                        <h2 className="text-2xl font-bold flex items-center gap-2">
                                            <Icon name="notebook" className="text-blue-500" />
                                            Notes & Highlights
                                        </h2>
                                        <span className="bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 px-3 py-1 rounded-full text-sm font-medium">
                                            {book.notes.length}
                                        </span>
                                    </div>
                                    
                                    {/* Filter Controls */}
                                    <div className="flex items-center gap-2 overflow-x-auto pb-2 sm:pb-0 scrollbar-hide">
                                        <span className="text-xs font-bold uppercase text-gray-400 whitespace-nowrap">Filter:</span>
                                        <button 
                                            onClick={() => setFilterColor('all')}
                                            className={`px-3 py-1 rounded-full text-xs font-medium border transition-colors whitespace-nowrap
                                                ${filterColor === 'all' 
                                                    ? 'bg-gray-800 text-white border-gray-800 dark:bg-white dark:text-slate-900' 
                                                    : 'bg-white text-gray-600 border-gray-200 hover:border-gray-300 dark:bg-slate-800 dark:text-gray-400 dark:border-slate-700'}`}
                                        >
                                            All
                                        </button>
                                        {PASTEL_PALETTE.map(color => (
                                            <button
                                                key={color.id}
                                                onClick={() => setFilterColor(color.id)}
                                                className={`w-6 h-6 rounded-full border-2 transition-all flex-shrink-0
                                                    ${color.dot} 
                                                    ${filterColor === color.id ? 'border-gray-600 dark:border-gray-200 scale-110' : 'border-transparent opacity-50 hover:opacity-100'}`}
                                                title={`Filter by ${color.name}`}
                                            />
                                        ))}
                                    </div>
                                </div>

                                {/* Add Note Form */}
                                <form onSubmit={handleAddNote} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 mb-8">
                                    <textarea
                                        className="w-full bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg p-3 mb-3 focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                                        rows="3"
                                        placeholder="Write your thought, quote, or reference..."
                                        value={noteText}
                                        onChange={(e) => setNoteText(e.target.value)}
                                    ></textarea>
                                    
                                    <div className="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
                                        <div className="flex gap-3 w-full sm:w-auto">
                                            <input 
                                                type="text" 
                                                placeholder="Pg #" 
                                                className="w-20 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                value={notePage}
                                                onChange={(e) => setNotePage(e.target.value)}
                                            />
                                            <input 
                                                type="text" 
                                                placeholder="Line #" 
                                                className="w-20 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                                value={noteLine}
                                                onChange={(e) => setNoteLine(e.target.value)}
                                            />
                                        </div>

                                        <div className="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs font-bold text-gray-400 uppercase">Color:</span>
                                                <ColorPicker selectedId={selectedColor} onSelect={setSelectedColor} size="sm" />
                                            </div>
                                            <button 
                                                type="submit" 
                                                disabled={!noteText.trim()}
                                                className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
                                            >
                                                Add Note
                                            </button>
                                        </div>
                                    </div>
                                </form>

                                {/* Notes List */}
                                <div className="space-y-4">
                                    {book.notes.length === 0 ? (
                                        <p className="text-center text-gray-400 italic py-8">No notes yet. Add your first thought above!</p>
                                    ) : filteredNotes.length === 0 ? (
                                        <p className="text-center text-gray-400 italic py-8">No notes found with this color filter.</p>
                                    ) : (
                                        filteredNotes.map((note, index) => {
                                            // Determine color object
                                            let colorObj;
                                            if (note.colorId) {
                                                colorObj = PASTEL_PALETTE.find(c => c.id === note.colorId) || PASTEL_PALETTE[0];
                                            } else if (note.color) {
                                                // Legacy support
                                                const legacyId = note.color.name.toLowerCase();
                                                colorObj = PASTEL_PALETTE.find(c => c.id === legacyId) || PASTEL_PALETTE[index % PASTEL_PALETTE.length];
                                            } else {
                                                colorObj = PASTEL_PALETTE[index % PASTEL_PALETTE.length];
                                            }
                                            
                                            const isEditingColor = colorPickerNoteId === note.id;
                                            const isEditingText = textEditingId === note.id;

                                            return (
                                                <div key={note.id} className="group bg-white dark:bg-slate-800 rounded-xl border border-gray-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all relative overflow-hidden">
                                                    {/* Left Color Block */}
                                                    <div className={`absolute top-0 bottom-0 left-0 w-2 ${colorObj.dot}`}></div>
                                                    
                                                    <div className="p-5 pl-7">
                                                        <div className="flex justify-between items-start mb-2">
                                                            {/* Metadata Text */}
                                                            {!isEditingText && (
                                                                <div className="flex gap-2 text-xs font-bold uppercase tracking-wide opacity-70 text-gray-400 dark:text-gray-500">
                                                                    {note.page && <span>Page {note.page}</span>}
                                                                    {note.page && note.line && <span>â€¢</span>}
                                                                    {note.line && <span>Line {note.line}</span>}
                                                                </div>
                                                            )}
                                                            
                                                            {/* Action Buttons */}
                                                            {!isEditingText && (
                                                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity ml-auto">
                                                                     <button 
                                                                        onClick={() => handleStartEdit(note)}
                                                                        className="text-gray-300 hover:text-blue-500"
                                                                        title="Edit Note"
                                                                     >
                                                                        <Icon name="pencil-simple" />
                                                                     </button>
                                                                     
                                                                     <div className="relative">
                                                                        <button 
                                                                            onClick={() => setColorPickerNoteId(isEditingColor ? null : note.id)} 
                                                                            className="text-gray-300 hover:text-purple-500"
                                                                            title="Change Color"
                                                                        >
                                                                            <Icon name="palette" />
                                                                        </button>
                                                                        {isEditingColor && (
                                                                            <div className="absolute right-0 top-8 bg-white dark:bg-slate-900 p-3 rounded-xl shadow-xl border border-gray-100 dark:border-slate-700 z-10 w-48 animate-in fade-in zoom-in duration-200">
                                                                                <ColorPicker 
                                                                                    selectedId={colorObj.id} 
                                                                                    onSelect={(newId) => handleEditNoteColor(note.id, newId)} 
                                                                                    size="sm"
                                                                                />
                                                                            </div>
                                                                        )}
                                                                     </div>
                                                                     
                                                                    <button 
                                                                        onClick={() => handleDeleteNote(note.id)} 
                                                                        className="text-gray-300 hover:text-red-500"
                                                                        title="Delete Note"
                                                                    >
                                                                        <Icon name="trash" />
                                                                    </button>
                                                                </div>
                                                            )}
                                                        </div>

                                                        {/* Note Content or Edit Form */}
                                                        {isEditingText ? (
                                                            <div className="mt-2">
                                                                <div className="flex gap-2 mb-2">
                                                                     <input 
                                                                        type="text" 
                                                                        placeholder="Pg #" 
                                                                        className="w-20 bg-gray-50 dark:bg-slate-900 border border-blue-500 rounded-lg px-2 py-1 text-sm outline-none dark:text-gray-200"
                                                                        value={editPage}
                                                                        onChange={(e) => setEditPage(e.target.value)}
                                                                    />
                                                                    <input 
                                                                        type="text" 
                                                                        placeholder="Line #" 
                                                                        className="w-20 bg-gray-50 dark:bg-slate-900 border border-blue-500 rounded-lg px-2 py-1 text-sm outline-none dark:text-gray-200"
                                                                        value={editLine}
                                                                        onChange={(e) => setEditLine(e.target.value)}
                                                                    />
                                                                </div>
                                                                <textarea
                                                                    className="w-full bg-gray-50 dark:bg-slate-900 border border-blue-500 rounded-lg p-3 text-gray-800 dark:text-gray-200 outline-none resize-none mb-2"
                                                                    rows="3"
                                                                    value={editText}
                                                                    onChange={(e) => setEditText(e.target.value)}
                                                                    autoFocus
                                                                />
                                                                <div className="flex justify-end gap-2">
                                                                    <button 
                                                                        onClick={() => setTextEditingId(null)}
                                                                        className="px-3 py-1 text-sm rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700"
                                                                    >
                                                                        Cancel
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => handleSaveEdit(note.id)}
                                                                        className="px-3 py-1 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700"
                                                                        disabled={!editText.trim()}
                                                                    >
                                                                        Save
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <p className="whitespace-pre-wrap leading-relaxed text-gray-800 dark:text-gray-200">{note.text}</p>
                                                        )}

                                                        {!isEditingText && (
                                                            <div className="mt-3 text-right text-xs text-gray-400 opacity-75">
                                                                {new Date(note.date).toLocaleDateString()}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---

        const App = () => {
            const [books, setBooks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [firebaseConfig, setFirebaseConfig] = useState(() => {
                const saved = localStorage.getItem('firebase-config');
                return saved ? JSON.parse(saved) : {
                    apiKey: "AIzaSyA3jIv8aQBPTt5L1VPXG7FDLunDpp7cwqs",
                    authDomain: "bookkeeper-dcb87.firebaseapp.com",
                    projectId: "bookkeeper-dcb87",
                    storageBucket: "bookkeeper-dcb87.firebasestorage.app",
                    messagingSenderId: "82166085378",
                    appId: "1:82166085378:web:efdde01c7919094d75b41b",
                    measurementId: "G-WQCBBT1GHF"
                };
            });
            const [collectionName, setCollectionName] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                const urlList = params.get('list');
                if (urlList) return urlList;
                return localStorage.getItem('collection-name') || 'books';
            });
            const [db, setDb] = useState(null);

            const [darkMode, setDarkMode] = useState(() => {
                return localStorage.getItem('theme') === 'dark' || 
                       (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            });
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isSyncModalOpen, setIsSyncModalOpen] = useState(false);
            const [deleteConfirmation, setDeleteConfirmation] = useState({ isOpen: false, bookId: null });
            const [selectedBookId, setSelectedBookId] = useState(null);
            
            // Filters
            const [searchTerm, setSearchTerm] = useState("");
            const [sortOption, setSortOption] = useState("date-desc");
            const [genreFilter, setGenreFilter] = useState("All");
            const [statusFilter, setStatusFilter] = useState("All");

            // --- Storage Logic ---
            
            // 1. Initialize Firebase if config exists
            useEffect(() => {
                if (firebaseConfig) {
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        const firestore = firebase.firestore();
                        setDb(firestore);
                    } catch (e) {
                        console.error("Firebase init failed", e);
                        alert("Failed to connect to Firebase. Check your configuration.");
                        setDb(null);
                    }
                } else {
                    setDb(null);
                }
            }, [firebaseConfig]);

            // 2. Data Subscription (Dual Mode)
            useEffect(() => {
                setIsLoading(true);
                if (db) {
                    // Cloud Mode
                    const unsubscribe = db.collection(collectionName).onSnapshot((snapshot) => {
                        const booksData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        setBooks(booksData);
                        setIsLoading(false);
                    }, (error) => {
                        console.error("Sync error", error);
                        setIsLoading(false);
                    });
                    return () => unsubscribe();
                } else {
                    // Local Mode
                    const saved = localStorage.getItem('my-books');
                    if (saved) setBooks(JSON.parse(saved));
                    setIsLoading(false);
                }
            }, [db, collectionName]);

            // 3. Persist Local (only in Local Mode)
            useEffect(() => {
                if (!db && !isLoading) {
                    localStorage.setItem('my-books', JSON.stringify(books));
                }
            }, [books, db, isLoading]);

            // --- Actions ---

            const handleAddBook = async (newBook) => {
                if (db) {
                    // Remove ID, let Firestore generate it
                    const { id, ...bookData } = newBook;
                    await db.collection(collectionName).add(bookData);
                } else {
                    setBooks([newBook, ...books]);
                }
            };

            const handleUpdateBook = async (updatedBook) => {
                if (db) {
                    await db.collection(collectionName).doc(updatedBook.id).update(updatedBook);
                } else {
                    setBooks(books.map(b => b.id === updatedBook.id ? updatedBook : b));
                }
            };

            const handleDeleteBook = (id) => {
                setDeleteConfirmation({ isOpen: true, bookId: id });
            };

            const performDelete = async () => {
                if (deleteConfirmation.bookId) {
                    if (db) {
                         await db.collection(collectionName).doc(deleteConfirmation.bookId).delete();
                    } else {
                        setBooks(books.filter(b => b.id !== deleteConfirmation.bookId));
                    }
                    if (selectedBookId === deleteConfirmation.bookId) setSelectedBookId(null);
                }
                setDeleteConfirmation({ isOpen: false, bookId: null });
            };

            // --- Theme ---
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [darkMode]);

            const handleSaveConfig = (config, collection) => {
                localStorage.setItem('firebase-config', JSON.stringify(config));
                localStorage.setItem('collection-name', collection);
                setFirebaseConfig(config);
                setCollectionName(collection);
                setIsSyncModalOpen(false);

                // Update URL
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('list', collection);
                window.history.pushState({}, '', newUrl);

                alert(`Connected to list: ${collection}`);
            };

            const handleClearConfig = () => {
                localStorage.removeItem('firebase-config');
                localStorage.removeItem('collection-name');
                setFirebaseConfig(null);
                setCollectionName('books');
                setDb(null);
                setIsSyncModalOpen(false);

                // Clear URL param
                const newUrl = new URL(window.location);
                newUrl.searchParams.delete('list');
                window.history.pushState({}, '', newUrl);

                alert("Disconnected. Switched back to offline storage.");
            };

            // Derived State
            const allGenres = useMemo(() => {
                const genres = new Set(books.map(b => b.categories?.[0]).filter(Boolean));
                return ["All", ...Array.from(genres).sort()];
            }, [books]);

            const filteredBooks = useMemo(() => {
                return books
                    .filter(book => {
                        const matchesSearch = book.title.toLowerCase().includes(searchTerm.toLowerCase());
                        const matchesGenre = genreFilter === "All" || book.categories?.[0] === genreFilter;
                        const matchesStatus = statusFilter === "All" || (book.status || 'want-to-read') === statusFilter;
                        return matchesSearch && matchesGenre && matchesStatus;
                    })
                    .sort((a, b) => {
                        switch (sortOption) {
                            case "title-asc": return a.title.localeCompare(b.title);
                            case "title-desc": return b.title.localeCompare(a.title);
                            case "rating-desc": return b.rating - a.rating;
                            case "date-desc": return new Date(b.dateAdded) - new Date(a.dateAdded);
                            case "date-asc": return new Date(a.dateAdded) - new Date(b.dateAdded);
                            default: return 0;
                        }
                    });
            }, [books, searchTerm, sortOption, genreFilter, statusFilter]);

            const selectedBook = books.find(b => b.id === selectedBookId);

            return (
                <div className="max-w-6xl mx-auto px-4 py-8 min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 text-white p-2 rounded-lg">
                                <Icon name="books" size={32} />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold tracking-tight">BookTracker</h1>
                                {db ? (
                                    <span className="text-xs font-medium text-green-600 bg-green-100 dark:bg-green-900/30 dark:text-green-400 px-2 py-0.5 rounded flex items-center gap-1 w-fit">
                                        <Icon name="cloud-check" size={12}/> {collectionName}
                                    </span>
                                ) : (
                                    <span className="text-xs font-medium text-gray-500 bg-gray-100 dark:bg-slate-800 dark:text-gray-400 px-2 py-0.5 rounded flex items-center gap-1 w-fit">
                                        <Icon name="floppy-disk" size={12}/> Offline
                                    </span>
                                )}
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button 
                                onClick={() => setIsSyncModalOpen(true)}
                                className={`p-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium ${db ? 'text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-800'}`}
                                title="Sync Settings"
                            >
                                <Icon name={db ? "cloud-check" : "cloud-slash"} />
                                <span className="hidden sm:inline">{db ? "Sync On" : "Cloud Sync"}</span>
                            </button>
                            <button 
                                onClick={() => setDarkMode(!darkMode)}
                                className="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors"
                                title="Toggle Theme"
                            >
                                <Icon name={darkMode ? "sun" : "moon"} />
                            </button>
                            <button 
                                onClick={() => setIsAddModalOpen(true)}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-lg hover:shadow-blue-500/25"
                            >
                                <Icon name="plus" weight="bold" /> Add Book
                            </button>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="flex-1">
                        {selectedBook ? (
                            <BookDetail 
                                book={selectedBook} 
                                onBack={() => setSelectedBookId(null)}
                                onUpdate={handleUpdateBook}
                                onDelete={handleDeleteBook}
                            />
                        ) : (
                            <div className="space-y-6">
                                {/* Toolbar */}
                                <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 flex flex-col md:flex-row gap-4">
                                    <div className="flex-1 relative">
                                        <Icon name="magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                                        <input 
                                            type="text" 
                                            placeholder="Filter your library..." 
                                            className="w-full bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg pl-10 pr-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        <select 
                                            className="bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                            value={statusFilter}
                                            onChange={(e) => setStatusFilter(e.target.value)}
                                        >
                                            <option value="All">All Statuses</option>
                                            {STATUS_OPTIONS.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}
                                        </select>
                                        <select 
                                            className="bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                            value={genreFilter}
                                            onChange={(e) => setGenreFilter(e.target.value)}
                                        >
                                            {allGenres.map(g => <option key={g} value={g}>{g}</option>)}
                                        </select>
                                        <select 
                                            className="bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                            value={sortOption}
                                            onChange={(e) => setSortOption(e.target.value)}
                                        >
                                            <option value="date-desc">Newest First</option>
                                            <option value="date-asc">Oldest First</option>
                                            <option value="title-asc">Title (A-Z)</option>
                                            <option value="title-desc">Title (Z-A)</option>
                                            <option value="rating-desc">Highest Rated</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Stats */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-blue-50 dark:bg-slate-800/50 p-4 rounded-xl border border-blue-100 dark:border-slate-700">
                                        <p className="text-sm text-gray-500 dark:text-gray-400">Total Books</p>
                                        <p className="text-2xl font-bold text-blue-600">{books.length}</p>
                                    </div>
                                    <div className="bg-green-50 dark:bg-slate-800/50 p-4 rounded-xl border border-green-100 dark:border-slate-700">
                                        <p className="text-sm text-gray-500 dark:text-gray-400">Total Notes</p>
                                        <p className="text-2xl font-bold text-green-600">{books.reduce((acc, b) => acc + (b.notes ? b.notes.length : 0), 0)}</p>
                                    </div>
                                </div>

                                {/* Grid */}
                                {isLoading ? (
                                    <div className="flex justify-center py-20">
                                        <Icon name="spinner" className="animate-spin text-blue-600" size={40} />
                                    </div>
                                ) : filteredBooks.length > 0 ? (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                        {filteredBooks.map(book => (
                                            <BookCard 
                                                key={book.id} 
                                                book={book} 
                                                onClick={() => setSelectedBookId(book.id)} 
                                                onDelete={handleDeleteBook}
                                            />
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-20 bg-gray-50 dark:bg-slate-800/30 rounded-xl border border-dashed border-gray-200 dark:border-slate-700">
                                        <Icon name="books" size={48} className="mx-auto text-gray-300 mb-4" />
                                        <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-1">No books found</h3>
                                        <p className="text-gray-500">Try adjusting your filters or add a new book.</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    <AddBookModal 
                        isOpen={isAddModalOpen} 
                        onClose={() => setIsAddModalOpen(false)} 
                        onAdd={handleAddBook} 
                    />

                    <SyncSettingsModal
                        isOpen={isSyncModalOpen}
                        onClose={() => setIsSyncModalOpen(false)}
                        onSave={handleSaveConfig}
                        onClear={handleClearConfig}
                        currentConfig={firebaseConfig}
                        currentCollection={collectionName}
                    />

                    <ConfirmModal 
                        isOpen={deleteConfirmation.isOpen}
                        onClose={() => setDeleteConfirmation({ isOpen: false, bookId: null })}
                        onConfirm={performDelete}
                        title="Delete Book?"
                        message="Are you sure you want to delete this book and all its notes? This action cannot be undone."
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
